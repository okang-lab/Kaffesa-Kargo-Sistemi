<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Kargo Etiketi Oluşturucu</title>
  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- React (CDN) -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <!-- Kütüphaneler -->
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://unpkg.com/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://unpkg.com/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <style>
    @page { size:A4; margin:12mm; }
    @media print {
      body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
      .a4 { width:210mm; min-height:297mm; padding:10mm; }
      .label-box { break-inside: avoid; }
    }
  </style>
</head>
<body class="bg-neutral-50">
  <div id="root"></div>

  <script>
    const { useState, useMemo, useRef } = React;

    function App() {
      const [raw, setRaw] = useState("");
      const [rows, setRows] = useState([]);
      const [headers, setHeaders] = useState([]);
      const [sender, setSender] = useState({
        name: "Kaffesa Limited",
        phone: "+90 212 000 00 00",
        address: "Maslak Mah. Ağaçlı Sk. No:10/3 Sarıyer / İstanbul, Türkiye",
      });
      const [mapping, setMapping] = useState({
        recipient: "", phone: "", address: "", address2: "", notes: ""
      });
      const [ready, setReady] = useState(false);
      const sheetRef = useRef(null);

      function parseRaw() {
        const parsed = Papa.parse(raw.trim(), { delimiter:"", skipEmptyLines:true });
        let data = parsed.data || [];
        let inferredHeaders = [];
        if (data.length > 0) {
          const first = data[0];
          const looksLikeHeader = first.every((cell) => {
            const c = String(cell||"").trim();
            return c.length <= 30 && /[A-Za-zÇĞİÖŞÜçğıöşü]/.test(c) && !/\d{7,}/.test(c);
          });
          if (looksLikeHeader) {
            inferredHeaders = first.map((c,i)=> String(c).trim() || `Kolon ${i+1}`);
            data = data.slice(1);
          } else {
            inferredHeaders = first.map((_,i)=> `Kolon ${i+1}`);
          }
        }
        setHeaders(inferredHeaders);
        setRows(data);

        const lower = inferredHeaders.map(h=>h.toLowerCase());
        const idxName  = lower.findIndex(h=>/(alıcı|firma|isim|ad|name|company)/.test(h));
        const idxPhone = lower.findIndex(h=>/(telefon|phone|gsm|mobile)/.test(h));
        const idxAddr  = lower.findIndex(h=>/(adres|address|street|cadde|sokak)/.test(h));
        setMapping({
          recipient: idxName>=0? String(idxName):"0",
          phone:     idxPhone>=0?String(idxPhone):(lower.length>1?"1":"0"),
          address:   idxAddr>=0? String(idxAddr):(lower.length>2?"2":"0"),
          address2:  "",
          notes:     ""
        });
        setReady(data.length>0);
      }

      const columns = useMemo(()=> headers.map((h,i)=>({label:h||`Kolon ${i+1}`, value:String(i)})), [headers]);

      const labels = useMemo(()=> {
        if(!ready) return [];
        const get = (row, key)=>{
          const idxStr = mapping[key];
          if(!idxStr) return "";
          const idx = parseInt(idxStr,10);
          return row[idx] ?? "";
        };
        return rows.map(r=>({
          recipient: String(get(r,"recipient")).trim(),
          phone:     String(get(r,"phone")).trim(),
          address:   [String(get(r,"address")).trim(), String(get(r,"address2")).trim()].filter(Boolean).join(" "),
          notes:     String(get(r,"notes")).trim(),
        }));
      }, [rows, mapping, ready]);

      async function downloadPDF() {
        if(!sheetRef.current) return;
        const canvas = await html2canvas(sheetRef.current, { scale:2, useCORS:true, backgroundColor:"#fff" });
        const imgData = canvas.toDataURL("image/png");
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF({ unit:"mm", format:"a4" });
        const pageW = 210, imgW = pageW, imgH = (canvas.height * imgW) / canvas.width;
        if (imgH <= 297) {
          pdf.addImage(imgData, "PNG", 0, 0, imgW, imgH);
        } else {
          let remaining = imgH;
          const sliceHeightPx = (297 * canvas.height) / imgH;
          let pos = 0, y = 0;
          while (remaining > 0) {
            const s = document.createElement("canvas");
            s.width = canvas.width;
            s.height = Math.min(sliceHeightPx, canvas.height - pos);
            s.getContext("2d").drawImage(canvas, 0, pos, canvas.width, s.height, 0, 0, canvas.width, s.height);
            const sliceData = s.toDataURL("image/png");
            const sliceH = (s.height * imgW) / canvas.width;
            if (y>0) pdf.addPage();
            pdf.addImage(sliceData, "PNG", 0, 0, imgW, sliceH);
            pos += s.height;
            remaining -= sliceH;
            y += sliceH;
          }
        }
        pdf.save("kargo-etiketleri.pdf");
      }

      const FieldMap = ({ label, value, onChange, options }) => (
        React.createElement("div", { className:"space-y-1" },
          React.createElement("label", { className:"text-sm text-neutral-700" }, label),
          React.createElement("select", {
            className:"w-full border rounded-lg p-2",
            value, onChange:e=>onChange(e.target.value)
          },
            options.map(o=> React.createElement("option", {key:o.value, value:o.value}, o.label))
          )
        )
      );

      return (
        React.createElement("div", { className:"min-h-screen w-full p-6" },
          React.createElement("div", { className:"mx-auto max-w-6xl space-y-6" },
            React.createElement("div", { className:"flex items-center justify-between" },
              React.createElement("h1", { className:"text-2xl md:text-3xl font-semibold" }, "Kargo Etiketi Oluşturucu"),
              React.createElement("div", { className:"flex gap-2" },
                React.createElement("button", { className:"px-3 py-2 rounded-lg border", onClick:()=>window.print() }, "Yazdır / PDF Kaydet"),
                React.createElement("button", { className:"px-3 py-2 rounded-lg bg-black text-white", onClick:downloadPDF }, "PDF İndir (A4)")
              )
            ),

            React.createElement("div", { className:"grid md:grid-cols-2 gap-4" },
              React.createElement("div", { className:"bg-white p-4 rounded-2xl border space-y-3" },
                React.createElement("div", null,
                  React.createElement("label", { className:"block text-sm text-neutral-700 mb-1" }, "Excel'den satır(lar) yapıştırın (CSV/TSV kabul)"),
                  React.createElement("textarea", {
                    className:"w-full min-h-[150px] border rounded-lg p-2",
                    placeholder:"Alıcı,Fon,Adres\nAcme A.Ş.,05001234567,İstiklal Cd. No:5 Beyoğlu/İstanbul",
                    value:raw, onChange:e=>setRaw(e.target.value)
                  })
                ),
                React.createElement("div", { className:"flex items-center gap-2" },
                  React.createElement("button", { className:"px-3 py-2 rounded-lg bg-black text-white", onClick:parseRaw }, "Veriyi Yükle"),
                  React.createElement("div", { className:"text-sm text-neutral-500" }, rows.length>0 ? `${rows.length} satır yüklendi` : "Henüz veri yok")
                ),

                React.createElement("div", { className:"grid sm:grid-cols-2 gap-3" },
                  React.createElement(FieldMap, { label:"Alıcı/Firma", value:mapping.recipient, onChange:v=>setMapping({...mapping,recipient:v}), options:columns }),
                  React.createElement(FieldMap, { label:"Telefon", value:mapping.phone, onChange:v=>setMapping({...mapping,phone:v}), options:columns }),
                  React.createElement(FieldMap, { label:"Adres", value:mapping.address, onChange:v=>setMapping({...mapping,address:v}), options:columns }),
                  React.createElement(FieldMap, { label:"Adres 2 (ops.)", value:mapping.address2, onChange:v=>setMapping({...mapping,address2:v}), options:[{label:"Yok", value:""}, ...columns] }),
                  React.createElement(FieldMap, { label:"Not (ops.)", value:mapping.notes, onChange:v=>setMapping({...mapping,notes:v}), options:[{label:"Yok", value:""}, ...columns] })
                )
              ),

              React.createElement("div", { className:"bg-white p-4 rounded-2xl border space-y-3" },
                React.createElement("div", { className:"grid md:grid-cols-3 gap-3" },
                  React.createElement("div", null,
                    React.createElement("label", { className:"block text-sm text-neutral-700 mb-1" }, "Gönderici Ad / Firma"),
                    React.createElement("input", { className:"w-full border rounded-lg p-2", value:sender.name, onChange:e=>setSender({...sender, name:e.target.value}) })
                  ),
                  React.createElement("div", null,
                    React.createElement("label", { className:"block text-sm text-neutral-700 mb-1" }, "Gönderici Telefon"),
                    React.createElement("input", { className:"w-full border rounded-lg p-2", value:sender.phone, onChange:e=>setSender({...sender, phone:e.target.value}) })
                  ),
                  React.createElement("div", { className:"md:col-span-3" },
                    React.createElement("label", { className:"block text-sm text-neutral-700 mb-1" }, "Gönderici Adres"),
                    React.createElement("input", { className:"w-full border rounded-lg p-2", value:sender.address, onChange:e=>setSender({...sender, address:e.target.value}) })
                  )
                ),
                React.createElement("div", { className:"text-xs text-neutral-500" }, "Bu bilgiler tüm etiketlere sabit olarak eklenir.")
              )
            ),

            React.createElement("div", { className:"bg-white p-4 rounded-2xl border" },
              labels.length === 0
                ? React.createElement("div", { className:"text-neutral-500" }, "Önizleme için veri yükleyin.")
                : React.createElement("div", null,
                    React.createElement("div", { className:"flex items-center justify-between mb-3" },
                      React.createElement("div", { className:"text-sm text-neutral-600" }, `Toplam ${labels.length} etiket`),
                      React.createElement("div", { className:"flex gap-2" },
                        React.createElement("button", { className:"px-3 py-2 rounded-lg border", onClick:()=>window.print() }, "Yazdır / PDF Kaydet"),
                        React.createElement("button", { className:"px-3 py-2 rounded-lg bg-black text-white", onClick:downloadPDF }, "PDF İndir (A4)")
                      )
                    ),
                    React.createElement("div", { ref:sheetRef, className:"a4 bg-white p-6 grid grid-cols-2 gap-4" },
                      labels.map((l,i)=>
                        React.createElement("div", { key:i, className:"label-box rounded-2xl border border-neutral-200 p-4 shadow-sm" },
                          React.createElement("div", { className:"grid grid-cols-2 gap-3" },
                            React.createElement("div", null,
                              React.createElement("div", { className:"text-[10px] uppercase tracking-wider text-neutral-500" }, "Gönderici"),
                              React.createElement("div", { className:"font-semibold leading-tight" }, sender.name),
                              React.createElement("div", { className:"text-sm leading-snug" }, sender.address),
                              React.createElement("div", { className:"text-sm" }, "Tel: ", sender.phone)
                            ),
                            React.createElement("div", { className:"text-right" },
                              React.createElement("div", { className:"text-[10px] uppercase tracking-wider text-neutral-500" }, "Tarih"),
                              React.createElement("div", { className:"text-sm" }, new Date().toLocaleDateString("tr-TR")),
                              React.createElement("div", { className:"text-[10px] uppercase tracking-wider text-neutral-500 mt-2" }, "Referans"),
                              React.createElement("div", { className:"text-xs" }, "#", String(i+1).padStart(4,"0"))
                            )
                          ),
                          React.createElement("div", { className:"my-3 h-px bg-neutral-200" }),
                          React.createElement("div", null,
                            React.createElement("div", { className:"text-[10px] uppercase tracking-wider text-neutral-500" }, "Alıcı"),
                            React.createElement("div", { className:"text-lg font-bold leading-tight" }, l.recipient || "-"),
                            React.createElement("div", { className:"text-base whitespace-pre-wrap leading-snug mt-1" }, l.address || "-"),
                            React.createElement("div", { className:"text-base mt-1" }, "Tel: ", l.phone || "-"),
                            l.notes ? React.createElement("div", { className:"text-sm mt-1 italic" }, "Not: ", l.notes) : null
                          )
                        )
                      )
                    )
                  )
            ),

            React.createElement("div", { className:"text-sm text-neutral-600 space-y-1" },
              React.createElement("p", null, "Excel’de satır(lar)ı kopyala → kutuya yapıştır → ‘Veriyi Yükle’."),
              React.createElement("p", null, "‘Yazdır / PDF Kaydet’ veya ‘PDF İndir (A4)’ ile çıktı al.")
            )
          )
        )
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(React.createElement(App));
  </script>
</body>
</html>
